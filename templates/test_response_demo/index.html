{% extends 'base.html' %}
{% load static %}

{% block title %}{{ demo_name }} - OpenAI Responses API ãƒ‡ãƒ¢{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">{{ demo_name }}</h1>
            <p class="lead">OpenAI Responses APIã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ãƒ‡ãƒ¢</p>
        </div>
    </div>

    <!-- å®Ÿè£…ä¾‹ã®èª¬æ˜ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>OpenAI API(IPO):å®Ÿè£…ä¾‹</h5>
                </div>
                <div class="card-body">
                    <p>responses.create()ã®åŸºæœ¬çš„ãªãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ãƒ‡ãƒ¢ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸+ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã§One-Shotå¿œç­”ã‚’å®Ÿè¡Œã€‚EasyInputMessageParamã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹ç¯‰ã—ã€ResponseProcessorUIã§çµæœè¡¨ç¤ºã€‚</p>
                    <pre><code>messages = get_default_messages()
messages.append(
    EasyInputMessageParam(role="user", content=user_input)
)

# çµ±ä¸€ã•ã‚ŒãŸAPIå‘¼ã³å‡ºã—ï¼ˆtemperatureãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œï¼‰
response = self.call_api_unified(messages, temperature=temperature)
ã€€â”— api_params = {
    "input": messages,
    "model": model
    }
    self.client.responses.create(**params)
ResponseProcessorUI.display_response(response)</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- APIè¨­å®šãƒ‘ãƒãƒ« -->
    <div class="row">
        <div class="col-md-8">
            <!-- ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card">
                <div class="card-header">
                    <h5>è³ªå•å…¥åŠ›</h5>
                </div>
                <div class="card-body">
                    <form id="queryForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="userInput" class="form-label">è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</label>
                            <textarea class="form-control" id="userInput" rows="4" placeholder="ä¾‹: {{ example_query }}">{{ example_query }}</textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modelSelect" class="form-label">ãƒ¢ãƒ‡ãƒ«é¸æŠ:</label>
                                <select class="form-select" id="modelSelect">
                                    {% for model in available_models %}
                                        <option value="{{ model }}" {% if model == default_model %}selected{% endif %}>{{ model }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="temperatureSlider" class="form-label">Temperature: <span id="temperatureValue">0.3</span></label>
                                <input type="range" class="form-range" id="temperatureSlider" min="0" max="1" step="0.05" value="0.3">
                                <div id="temperatureInfo" class="text-muted small"></div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="loadingSpinner" role="status"></span>
                            é€ä¿¡
                        </button>
                    </form>
                </div>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="card mt-4" id="resultCard" style="display: none;">
                <div class="card-header">
                    <h5>ğŸ¤– å¿œç­”çµæœ</h5>
                </div>
                <div class="card-body">
                    <div id="responseContent"></div>
                    
                    <!-- è©³ç´°æƒ…å ±ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#detailsCollapse">
                            ğŸ“Š è©³ç´°æƒ…å ±
                        </button>
                    </div>
                    <div class="collapse mt-3" id="detailsCollapse">
                        <div class="card card-body">
                            <div id="detailsContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="alert alert-danger mt-4" id="errorAlert" style="display: none;">
                <h6>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h6>
                <div id="errorMessage"></div>
            </div>
        </div>

        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="col-md-4">
            <!-- ãƒ¢ãƒ‡ãƒ«æƒ…å ± -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6>ğŸ“Š ãƒ¢ãƒ‡ãƒ«æƒ…å ±</h6>
                </div>
                <div class="card-body" id="modelInfo">
                    <div class="text-muted">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                </div>
            </div>

            <!-- ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ± -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6>ğŸ“ ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±</h6>
                </div>
                <div class="card-body" id="tokenInfo">
                    <div class="text-muted">å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                </div>
            </div>

            <!-- ä½¿ç”¨æ–¹æ³• -->
            <div class="card">
                <div class="card-header">
                    <h6>â„¹ï¸ ä½¿ç”¨æ–¹æ³•</h6>
                </div>
                <div class="card-body">
                    <ol class="small">
                        <li>è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</li>
                        <li>ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</li>
                        <li>å¿…è¦ã«å¿œã˜ã¦Temperatureã‚’èª¿æ•´ã—ã¦ãã ã•ã„</li>
                        <li>ã€Œé€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„</li>
                    </ol>
                    <hr>
                    <p class="small mb-0"><strong>æ³¨æ„:</strong> æ¨è«–ç³»ãƒ¢ãƒ‡ãƒ«ï¼ˆo1, o3, o4, gpt-5ç³»ï¼‰ã§ã¯Temperatureãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('queryForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultCard = document.getElementById('resultCard');
    const errorAlert = document.getElementById('errorAlert');
    const modelSelect = document.getElementById('modelSelect');
    const temperatureSlider = document.getElementById('temperatureSlider');
    const temperatureValue = document.getElementById('temperatureValue');
    const temperatureInfo = document.getElementById('temperatureInfo');
    const userInput = document.getElementById('userInput');

    // Temperatureå€¤ã®æ›´æ–°
    temperatureSlider.addEventListener('input', function() {
        temperatureValue.textContent = this.value;
    });

    // ãƒ¢ãƒ‡ãƒ«å¤‰æ›´æ™‚ã®å‡¦ç†
    modelSelect.addEventListener('change', function() {
        updateModelInfo(this.value);
    });

    // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±æ›´æ–°
    userInput.addEventListener('input', function() {
        updateTokenInfo();
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userInputValue = userInput.value.trim();
        if (!userInputValue) {
            showError('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™');
            return;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
        setLoading(true);
        hideError();
        hideResult();

        const formData = {
            user_input: userInputValue,
            model: modelSelect.value,
            temperature: parseFloat(temperatureSlider.value)
        };

        // CSRF tokenå–å¾—
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('/test_response_demo/process/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            setLoading(false);
            
            if (data.success) {
                showResult(data);
            } else {
                showError(data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            setLoading(false);
            showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        });
    });

    function setLoading(loading) {
        if (loading) {
            loadingSpinner.classList.remove('d-none');
            submitBtn.disabled = true;
        } else {
            loadingSpinner.classList.add('d-none');
            submitBtn.disabled = false;
        }
    }

    function showResult(data) {
        const responseContent = document.getElementById('responseContent');
        const detailsContent = document.getElementById('detailsContent');

        // å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã®è¡¨ç¤º
        if (data.texts && data.texts.length > 0) {
            responseContent.innerHTML = data.texts.map(text => 
                `<div class="mb-3"><div class="border-start border-primary ps-3">${text.replace(/\n/g, '<br>')}</div></div>`
            ).join('');
        } else {
            responseContent.innerHTML = '<div class="text-muted">ãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        }

        // è©³ç´°æƒ…å ±ã®è¡¨ç¤º
        const details = `
            <div class="row">
                <div class="col-md-4">
                    <strong>ãƒ¢ãƒ‡ãƒ«:</strong><br>
                    <span class="text-muted">${data.model}</span>
                </div>
                <div class="col-md-4">
                    <strong>å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³:</strong><br>
                    <span class="text-muted">${data.input_tokens.toLocaleString()}</span>
                </div>
                <div class="col-md-4">
                    <strong>å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³:</strong><br>
                    <span class="text-muted">${data.output_tokens.toLocaleString()}</span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>åˆè¨ˆãƒˆãƒ¼ã‚¯ãƒ³:</strong><br>
                    <span class="text-muted">${data.total_tokens.toLocaleString()}</span>
                </div>
                <div class="col-md-6">
                    <strong>ãƒ¬ã‚¹ãƒãƒ³ã‚¹ID:</strong><br>
                    <span class="text-muted small">${data.response.id || 'N/A'}</span>
                </div>
            </div>
        `;
        detailsContent.innerHTML = details;

        resultCard.style.display = 'block';
        resultCard.scrollIntoView({ behavior: 'smooth' });
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        errorAlert.style.display = 'block';
        errorAlert.scrollIntoView({ behavior: 'smooth' });
    }

    function hideError() {
        errorAlert.style.display = 'none';
    }

    function hideResult() {
        resultCard.style.display = 'none';
    }

    function updateModelInfo(modelName) {
        const modelInfo = document.getElementById('modelInfo');
        modelInfo.innerHTML = '<div class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>';

        fetch(`/test_response_demo/model/${modelName}/info/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const info = `
                    <div><strong>ãƒ¢ãƒ‡ãƒ«å:</strong> ${data.model_name}</div>
                    <div><strong>æœ€å¤§å…¥åŠ›:</strong> ${data.limits.max_tokens.toLocaleString()} ãƒˆãƒ¼ã‚¯ãƒ³</div>
                    <div><strong>æœ€å¤§å‡ºåŠ›:</strong> ${data.limits.max_output.toLocaleString()} ãƒˆãƒ¼ã‚¯ãƒ³</div>
                    <div><strong>æ¨è«–ãƒ¢ãƒ‡ãƒ«:</strong> ${data.is_reasoning_model ? 'ã¯ã„' : 'ã„ã„ãˆ'}</div>
                    ${data.pricing.input ? `<div><strong>å…¥åŠ›æ–™é‡‘:</strong> $${data.pricing.input}/1000ãƒˆãƒ¼ã‚¯ãƒ³</div>` : ''}
                    ${data.pricing.output ? `<div><strong>å‡ºåŠ›æ–™é‡‘:</strong> $${data.pricing.output}/1000ãƒˆãƒ¼ã‚¯ãƒ³</div>` : ''}
                `;
                modelInfo.innerHTML = info;

                // Temperatureæƒ…å ±ã®æ›´æ–°
                if (data.is_reasoning_model) {
                    temperatureInfo.textContent = 'æ¨è«–ç³»ãƒ¢ãƒ‡ãƒ«ã§ã¯temperatureã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“';
                    temperatureSlider.disabled = true;
                } else {
                    temperatureInfo.textContent = 'ä½ã„å€¤ã»ã©ä¸€è²«æ€§ã®ã‚ã‚‹å›ç­”';
                    temperatureSlider.disabled = false;
                }
            } else {
                modelInfo.innerHTML = '<div class="text-danger">æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        })
        .catch(error => {
            modelInfo.innerHTML = '<div class="text-danger">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼</div>';
        });
    }

    function updateTokenInfo() {
        const text = userInput.value.trim();
        const tokenInfo = document.getElementById('tokenInfo');
        
        if (!text) {
            tokenInfo.innerHTML = '<div class="text-muted">å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
            return;
        }

        // ç°¡æ˜“çš„ãªãƒˆãƒ¼ã‚¯ãƒ³æ•°æ¨å®šï¼ˆå®Ÿéš›ã®å€¤ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰
        const estimatedTokens = Math.ceil(text.length / 3);
        tokenInfo.innerHTML = `
            <div><strong>æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•°:</strong> ${estimatedTokens.toLocaleString()}</div>
            <div class="small text-muted">â€»å®Ÿéš›ã®å€¤ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</div>
        `;
    }

    // åˆæœŸåŒ–
    updateModelInfo(modelSelect.value);
    updateTokenInfo();
});
</script>
{% endblock %}